
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
        <script type="text/javascript" src="https://static.facilio.com/apps-sdk/latest/facilio_apps_sdk.min.js"></script>
        <script
        type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/chart.js"
      ></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.0.2/dist/chartjs-chart-treemap.min.js"></script>
      <style>
        #Chart{ 
          height: 100% !important;
          width: 100% !important;
        }
      </style>
    </head>
    
    <body>
        <div id="app">
            <div>
                <canvas id="Chart"></canvas>
            </div>
        </div>
    </body>
    
    <script type="text/javascript">
        const colors = ['#006600', '#009900','#00cc00','#ffad99','#ff704d','#ff3300']
        var app = new Vue({
            el: '#app',
            data() {
                return {
                    resulttags:[],
                    workordersvsorg:{},
                    orgIdvsname: { 725647: "BK" ,727652: "EDC",725652: "EFM", 725648: "EHG", 725649: "EMG", 725651: "EP", 725650: "ERG"} ,
                    mychart:null,
                    response: null,
                    option:{ 
                      method: "put",
                      data: {
                        reportId: 5920,
                      },
                    },
                    option1:{ 
                      method: "put",
                      data: {
                        reportId: 5919,
                      },
                    },
                    config:{ 
                      type: "treemap",
                      data: {
                        datasets: [{
                          tree: null,
                          key: "Cost Per Workorder",
                          groups: ['ORG'],
                          spacing: 0,
                          borderWidth: 1,
                          labels:{ 
                              display:true,
                              formatter: function(data){
                                    return [`${data.raw.g}`, `No of Workorders: ${data.raw._data.children[0].workorder}`,`Cost per workorder: ${data.raw.v}`]
                              }        
                          },
                            backgroundColor: function(ctx){
                              if (ctx.type !== 'data') {
                                return 'transparent'
                              }
                              return colors[ctx.raw._data._idx]; 
                            }
                        }]
                      },
                      options: {
                        maintainAspectRatio: false,
                        plugins: {
                          title: {
                            display: true,
                            text: 'Workorder Vs Average Cost'
                          },
                          legend: {
                            display: false
                          },
                          tooltips: { enabled: false }
                        }
                      }
                    }
                }
            },
            mounted() 
            {
                window.facilioApp = FacilioAppSDK.init()
                let self =this;

                window.facilioApp.on('app.loaded', () => {
                
                window.facilioApp.request
                .invokeFacilioAPI("/v3/report/execute", self.option)
                .then((res) => 
                {
                    debugger
                  res.data.reportData.data.forEach(org_data => 
                  {
                    if(org_data.X && self.orgIdvsname[org_data.X])
                    {
                      let tag = { 'ORG' : self.orgIdvsname[org_data.X], 'Cost Per Workorder' : Number(org_data['Total cost'])}
                      self.resulttags.push(tag)
                    }
                  })
                  return Promise.resolve(2); 
                })
                .then(function(){
                    window.facilioApp.request
                    .invokeFacilioAPI("/v3/report/execute", self.option1)
                    .then((res) => 
                    {
                      res.data.reportData.data.forEach(org_data => 
                      {
                        if(org_data.X && self.orgIdvsname[org_data.X])
                        {
                            self.workordersvsorg[self.orgIdvsname[org_data.X]]= org_data.Id
                        }
                      })
                      for( i = 0 ; i < self.resulttags.length ; i++)
                      {
                        let org_obj = self.resulttags[i]
                        if(self.workordersvsorg[org_obj['ORG']])
                        {
                                let avgval = org_obj['Cost Per Workorder']/self.workordersvsorg[org_obj['ORG']]
                                org_obj['Cost Per Workorder'] = Math.round(avgval)
                                org_obj['workorder'] = self.workordersvsorg[org_obj['ORG']]
                        }
                      }
                     })
                    .then(function(){
                      self.resulttags = self.resulttags.sort((a, b) => a['Cost Per Workorder'] - b['Cost Per Workorder']);
                      var canvas = document.getElementById("Chart");
                      var ctx = canvas.getContext("2d");
                      self.config.data.datasets[0].tree = self.resulttags
                      var chart = window.chart = new Chart(ctx, self.config)
                  })
                })
              })
            }
        })
        
    </script>
    
    </html>
